# Smart Contract Security

The [Hedera Smart Contract Service (HSCS)](../../support-and-community/glossary.md#hedera-smart-contract-service-hscs) integrates the features of Hedera's third-generation native entity functionalityâ€”high throughput, fast finality, predictable and affordable fees, and fair transaction orderingâ€”with a highly optimized and performant second-generation [Ethereum Virtual Machine (EVM)](../../support-and-community/glossary.md#ethereum-virtual-machine-evm). We aim to offer comprehensive support for smart contracts originally written for other EVM-compatible chains and to enable their seamless deployment on Hedera.

***

## EVM Equivalence

We strive to ensure that developers can conveniently point to a Hedera-supported RPC endpoint and perform smart contract executions and queries using the same code and similar tools to achieve EVM equivalence. All smart contract transactions are executed using the [Besu EVM](../../support-and-community/glossary.md#hyperledger-besu-evm) to realize this objective, and the resulting changes are stored in the Hedera-optimized [Virtual Merkle Tree](../../support-and-community/glossary.md#virtual-merkle-tree) state. Users are thus guaranteed deterministic finality (as opposed to probabilistic finality) of smart contract executions within 2-3 seconds while ensuring that state changes are entirely encompassed within smart contract functionality.&#x20;

{% hint style="info" %}
ðŸ”” A Comprehensive breakdown of Hedera's EVM equivalence goals and exceptions can be found [**here**](understanding-hederas-evm-differences-and-compatibility/).&#x20;
{% endhint %}

***

## Security Model

### Old model (v1) boundaries

The old security model (pre [0.35.2](https://github.com/hashgraph/hedera-services/releases/tag/v0.35.2)) supported account key signatures provided at transaction time for authorization. Some of the key characteristics of this model included:

* [Smart contracts](../../support-and-community/glossary.md#smart-contract) could only change their own storage or the storage they were [delegate called](https://docs.soliditylang.org/en/v0.8.19/introduction-to-smart-contracts.html#delegatecall-and-libraries) with.
* System smart contracts could be delegate called to carry out [Hedera Token Service (HTS)](../../support-and-community/glossary.md#hedera-token-service-hts) operations on behalf of another account - Externally Owned Account (EOA) or contract account.
* Smart Contracts could change an EOAâ€™s storage with the appropriate signature in the transaction.
* Smart Contracts could change an EOAâ€™s balance with the appropriate signature in the transaction or with prior addition to an allowance approval list.

This greatly improved user experience as contracts could combine transactions in an attempt at atomicity. For instance, a contract could associate, transfer and approve transactions on a user's behalf with one signature. While focusing on usability, this approach did not address cases in which bad actors could carry out an unsanctioned transaction on behalf of a user, e.g., [https://hedera.com/blog/analysis-remediation-of-the-precompile-attack-on-the-hedera-network](https://hedera.com/blog/analysis-remediation-of-the-precompile-attack-on-the-hedera-network)

To address this, the core Hedera engineers thoroughly analyzed the Smart Contract Service and the HTS system contracts, aiming to secure the state and token assets of users and the network during Smart Contract executions. The results of this effort are the guidelines in [Consensus Node release v0.35.2](https://github.com/hashgraph/hedera-services/releases/tag/v0.35.2).

### New model (v2) boundaries

In the new security model, account key signatures cannot provide authorization for contract actions. Its key characteristics include:

* Smart contracts can only change their own storage or the storage they were [delegate called](https://docs.soliditylang.org/en/v0.8.19/introduction-to-smart-contracts.html#delegatecall-and-libraries) with.
* System smart contracts may **not** be delegate called, except from the Token proxy/facade flow, e.g., [HIP 719](https://hips.hedera.com/hip/hip-719). In such cases, HTS tokens are represented as smart contracts (see [HIP 218](https://hips.hedera.com/hip/hip-218)) for common ERC methods.
* Smart contracts can change an EOAs storage only if the contract ID is contained in the EOAs key.
* Smart contracts can change an EOAs balance if approved for a token allowance for a specific token held by the EOA.

#### Boundary comparison table

<table data-full-width="false"><thead><tr><th width="191">Boundary Spec</th><th width="238">v1 Model</th><th width="225">v2 Model</th><th align="center">Change</th></tr></thead><tbody><tr><td>Storage Changes</td><td>Smart Contracts could only change their own storage or the storage they were delegate called with</td><td>Smart contracts can only change their own storage or the storage they were delegate called with</td><td align="center"><strong>N</strong></td></tr><tr><td>System Contract Call Types</td><td>System smart contracts could be delegate called in order to carry out Hedera Token Service operations on behalf of another account (EOA) or contract.</td><td>System smart contracts may not be delegate called, except from the Token facade flow, which presents HTS tokens as smart contracts for common ERC methods.</td><td align="center"><strong>Y</strong></td></tr><tr><td>Permissioned Account Storage Changes</td><td>Smart Contracts could change an EOAâ€™s storage with the appropriate signature in the transaction.</td><td>Smart contracts can change an EOAs storage if the contract ID is contained in the EOAs key.</td><td align="center"><strong>Y</strong></td></tr><tr><td>Permissioned Account Balance Changes</td><td>Smart Contracts could change an accounts (EOA or contract) balance with the appropriate signature in the transaction or with prior addition to an allowance approval list</td><td>Smart contracts can change an EOAs balance if they have been approved a token allowance.</td><td align="center"><strong>Y</strong></td></tr></tbody></table>

In summary, HSCS utilizes a three-level security approach:

1. **Level 0 - EVM Security Model:** Entities may only modify their own state and balance.
2. **Level 1 - ERC Account Value Security Models:** Transfer and access to account value will follow tested web3 interface standards, e.g., ERC20, ERC721.
3. **Level 2 - Hedera Advanced Security Features:** Unique Hedera features may utilize contract-compatible permissions, e.g., ContractID keys.

<figure><img src="../../.gitbook/assets/SecurityModel01a.png" alt="" width="188"><figcaption><p>Hedera's three-level smart contract security model</p></figcaption></figure>

To achieve state change or value transfer, executions must adhere to the rules of each level. Transactions that donâ€™t satisfy the appropriate authorization will fail with response codes such as `INVALID_FULL_PREFIX_SIGNATURE_FOR_PRECOMPILE` when a sender is not authorized to carry out an operation. More operational-specific response codes will be returned where applicable e.g. `SPENDER_DOES_NOT_HAVE_ALLOWANCE`.

***

## Impact on Developers

### As a developer on Hedera, what should I do?

Developers are strongly encouraged to test their applications with new contracts and UX using the new security model to avoid unintended consequences.

* The new security model has been applied to contracts created from the mainnet [0.35.2 release](../../networks/release-notes/services.md#0.35.2-hedera-smart-contract-service-security-model-changes) and onwards.
* Existing contracts deployed before this upgrade will continue to use the previous security model for a limited time to allow for application/UX modifications.
* The previous security model will only be maintained for approximately three months. The current target is for the network to remove the previous security model and for all contracts to follow the new model by the mainnet release of July 2023.
* See a comprehensive list of the security updates made [here](security.md#0.35.2).&#x20;

### What does the change in the security model mean for smart contract developers?

The security update involves changes to entity permissions during contract executions when modifying the state. In short, system contract calls (smart contract calls to the Hedera Token Service) are no longer executed with all upper caller privileges, even if the authorized user provides a signature.

Understanding the process of contract executions for both externally owned accounts (EOAs) and contracts during regular and delegate calls is crucial. This process involves tracking how accounts, state (storage and value balance), and code may change as you progress through the chain of calls.

#### Before (v1 model)

In a regular call scenario, when a call is made to contract B, Bâ€™s code is executed in the context of its own state. This allows B to modify only its own state. The sender value also differs between the calls to highlight that the EOA made the first call and contract A made the second.

<figure><img src="../../.gitbook/assets/SecurityModel02rev - EOA.png" alt=""><figcaption></figcaption></figure>

#### After (v2 model)

On the other hand, in a delegate call scenario, the call to contract B sees Bâ€™s code executed in the context of Aâ€™s state. This allows B to modify Aâ€™s state. The sender and recipient values are preserved from the first call as if the EOA initiated the call.

<figure><img src="../../.gitbook/assets/SecurityModel03b - EOA.png" alt=""><figcaption></figcaption></figure>

In summary, a delegate call executes the calling contract's code in the context of the previous account, giving the code access to the previous account's state and blurring the lines of authorized state management.

Applying this to the security model changes, the following table summarizes the authorization check changes.

<table><thead><tr><th width="296">Scenario</th><th width="227">Authorization check</th><th width="107" align="center">Old Model</th><th align="center">New Model</th></tr></thead><tbody><tr><td>Smart contract A can change its own state using a call</td><td>sender = Contract A</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>Smart contract A can change EOAâ€™s state via call</td><td>sender = EOA</td><td align="center">N</td><td align="center">N</td></tr><tr><td>Smart contract B can change contract Aâ€™s state via call</td><td>sender = A</td><td align="center">N</td><td align="center">N</td></tr><tr><td>Smart contract A can change EOAâ€™s state via delegate call</td><td>sender = EOA</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>Smart contract B can change contract Aâ€™s state via delegate call</td><td>sender = Contract A</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td>System smart contracts can change another accounts (EOA or contract A or contract B) state via call</td><td>sender = account</td><td align="center">N</td><td align="center">N</td></tr><tr><td>System smart contract can change another accounts EOA or contract A or contract B) state via delegate call</td><td>sender = account</td><td align="center">N</td><td align="center">N</td></tr><tr><td><strong>System contracts can change an accounts (EOA or contact A or contract B) state via call with the appropriate signature</strong></td><td><strong>signature map contains signature of accounts (EOA or contact A or contract B respectively)</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr><tr><td><strong>System smart contract can change another accounts (EOA or contact A or contract B) state via delegate call with the appropriate signature</strong></td><td><strong>signature map contains signature of accounts (EOA or contact A or contract B)</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr><tr><td>Contract A or B can call a system contract via a call</td><td>-</td><td align="center">Y</td><td align="center">Y</td></tr><tr><td><strong>Contract A or B can call a system contract via a delegate call</strong></td><td><strong>-</strong></td><td align="center"><strong>Y</strong></td><td align="center"><strong>N</strong></td></tr></tbody></table>

At the time of the change, the [HTS system contract](https://github.com/hashgraph/hedera-smart-contracts/tree/release/0.3/contracts/hts-precompile) was the only pathway to expose Hedera API functionality through Smart Contracts. As such, itâ€™s fair to consider the differences between pre and post-security model updates when observing HTS system contract state-changing functions.

#### Existing HTS system contract impacts summary

<table data-full-width="false"><thead><tr><th width="212" align="center">IHederaTokenService System Smart Contract Function</th><th width="147" align="center">v1 Model Authorization Requirements</th><th width="139" align="center">v2 Model Authorization Requirements</th><th width="96" align="center">Impacts Code</th><th align="center">Solution by Developers</th></tr></thead><tbody><tr><td align="center"><strong>approve, approveNFT</strong></td><td align="center">signature map contains accounts admin key signature</td><td align="center"><code>msg.sender</code> must be entity to be modified</td><td align="center">Y</td><td align="center"><p>Upgrade contracts</p><p></p><p>or</p><p></p><p>Upgrade DApps to provide explicit user approval</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-376"><mark style="background-color:yellow;">HIP 376</mark></a> <mark style="background-color:yellow;">IERC.approve()</mark></p></td></tr><tr><td align="center"><strong>associateToken</strong></td><td align="center">signature map contains account admin key signature</td><td align="center"><code>msg.sender</code> must be entity to be modified</td><td align="center">Y</td><td align="center"><p>Upgrade contracts</p><p></p><p>or </p><p></p><p>Upgrade DApps to provide explicit user associate</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-719"><mark style="background-color:yellow;">HIP 719</mark></a> <mark style="background-color:yellow;">IHRC.associate()</mark></p></td></tr><tr><td align="center"><strong>burnToken</strong></td><td align="center"><p>signature map contains token burn key signature</p><p></p><p>or</p><p></p><p>Contract Id satisfies Token.supplyKey requirements</p></td><td align="center">Contract Id satisfies Token.supplyKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in Supply key</td></tr><tr><td align="center"><strong>createFungibleToken, createFungibleTokenWithCustomFees, createNonFungibleToken, createNonFungibleTokenWithCustomFees</strong></td><td align="center"><p>signature map contains affected account admin key signature(s) in treasury </p><p></p><p>or </p><p></p><p>autoRenew assignment case</p></td><td align="center"><p><code>msg.sender</code> must be entity to be modified in treasury </p><p></p><p>or </p><p></p><p>autoRenew assignment case</p></td><td align="center">Y</td><td align="center">-</td></tr><tr><td align="center"><strong>cryptoTransfer</strong></td><td align="center"><p>signature map contains sender admin key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Entity.key requirements</p></td><td align="center"><p><code>msg.sender</code> must be entity to be modified in treasury </p><p></p><p>or </p><p></p><p>autoRenew assignment case</p></td><td align="center">Y</td><td align="center">Upgrade DApps to provide explicit user approval.</td></tr><tr><td align="center"><strong>deleteToken</strong></td><td align="center"><p>signature map contains token admin key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.adminKey requirements</p></td><td align="center">Contract Id satisfies Token.adminKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in admin key</td></tr><tr><td align="center"><strong>dissociateToken, dissociateTokens</strong></td><td align="center">signature map contains admin key signature</td><td align="center"><code>msg.sender</code> must be entity to be modified</td><td align="center">Y</td><td align="center"><p>Upgrade contracts</p><p></p><p>or </p><p></p><p>Upgrade DApps to provide explicit user dissociate</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-719"><mark style="background-color:yellow;">HIP 719</mark></a> <mark style="background-color:yellow;">IHRC.associate()</mark></p></td></tr><tr><td align="center"><strong>freezeToken</strong></td><td align="center"><p>signature map contains freeze key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.freezeKey requirements</p></td><td align="center">Contract Id satisfies Token.freezeKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in freeze key</td></tr><tr><td align="center"><strong>grantTokenKyc</strong></td><td align="center"><p>signature map contains kyc key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.freezeKey requirements</p></td><td align="center">Contract Id satisfies Token.kycKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in kyc key</td></tr><tr><td align="center"><strong>mintToken</strong></td><td align="center"><p>signature map contains appropriate signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.supplyKey requirements</p></td><td align="center">Contract Id satisfies Token.supplyKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in Supply key</td></tr><tr><td align="center"><strong>pauseToken</strong></td><td align="center"><p>signature map contains pause key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.pauseKey requirements</p></td><td align="center">Contract Id satisfies Token.pauseKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in pause key</td></tr><tr><td align="center"><strong>revokeTokenKyc</strong></td><td align="center"><p>signature map contains kyc key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.freezeKey requirements</p></td><td align="center">Contract Id satisfies Token.kycKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in kyc key</td></tr><tr><td align="center"><strong>setApprovalForAll</strong></td><td align="center">signature map contains admin key signature</td><td align="center"><code>msg.sender</code> must be entity to be modified</td><td align="center">Y</td><td align="center"><p>Upgrade contracts</p><p></p><p>or</p><p></p><p>Upgrade DApps to provide explicit user associate</p><p></p><p><mark style="background-color:yellow;">*Additional secure pathways:</mark> <a href="https://hips.hedera.com/hip/hip-376"><mark style="background-color:yellow;">HIP 376</mark></a> <mark style="background-color:yellow;">IERC.setApprovalForAll()</mark></p></td></tr><tr><td align="center"><strong>transferFrom, transferFromNFT</strong></td><td align="center"><p>signature map contains admin key signature </p><p></p><p>or </p><p></p><p>Spender must have been pre-approved an allowance</p></td><td align="center"><p><code>msg.sender</code> must be entity to be modified in treasury </p><p></p><p>or </p><p></p><p>autoRenew assignment case</p></td><td align="center">Y</td><td align="center">Upgrade DApps to provide explicit user approval.</td></tr><tr><td align="center"><strong>transferToken, transferTokens, transferNFT, transferNFTs</strong></td><td align="center"><p>signature map contains admin key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Entity.key requirements </p><p></p><p>or </p><p></p><p>Contract has been approved an allowance to spend by owner</p></td><td align="center"><p><code>msg.sender</code> must be balance owner. </p><p></p><p>If not 1. Contract Id satisfies Entity.key requirements </p><p></p><p>or </p><p></p><p>2. Contract has been approved an allowance to spend by owner</p></td><td align="center">Y</td><td align="center">Upgrade DApps to provide explicit user approval.</td></tr><tr><td align="center"><strong>updateTokenInfo, updateTokenExpiryInfo, updateTokenKeys</strong></td><td align="center"><p>signature map contains token admin key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.adminKey requirements</p></td><td align="center">Contract Id satisfies Token.adminKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in admin key</td></tr><tr><td align="center"><strong>wipeTokenAccount, wipeTokenAccountNFT</strong></td><td align="center"><p>signature map contains token wipe key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.wipeKey requirements</p></td><td align="center">Contract Id satisfies Token.wipeKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in Wipe key</td></tr><tr><td align="center"><strong>unfreezeToken</strong></td><td align="center"><p>signature map contains token freeze key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.freezeKey requirements</p></td><td align="center">Contract Id satisfies Token.freezeKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in freeze key</td></tr><tr><td align="center"><strong>unpauseToken</strong></td><td align="center"><p>signature map contains token pause key signature </p><p></p><p>or </p><p></p><p>Contract Id satisfies Token.pauseKey requirements</p></td><td align="center">Contract Id satisfies Token.pauseKey requirements</td><td align="center">Y</td><td align="center">Token admin must set desired contract in pause key</td></tr></tbody></table>

{% hint style="info" %}
**Note:** While the changes impact user experience, requiring more explicit steps, they more than proportionately increase user and network security across the board. The team continues to push diligently to provide the community with secure and scalable API solutions to enable them to build creative dApps and carve out their own shared world on the ledger.
{% endhint %}

***

## Security Upgrades

<details>

<summary>0.35.2</summary>

* After the security incident on March 9th, the engineers conducted a thorough analysis of the Smart Contract Service and the Hedera Token Service system contracts.
* As part of this exercise, we did not find any additional vulnerabilities that could result in an attack that that which we witnessed on March 9th.
* The team also looked for any disparities between the expectations of a typical smart contract developer who is used to working with the Ethereum Virtual Machine (EVM) or ERC token APIs and the behaviors of the Hedera Token Service system contract APIs. Such differences in behavior could be used by a malicious smart contract developer in unexpected ways.
* In order to eliminate the possibility of these behavioral differences being utilized as attack vectors in the future, the consensus node software will align the behaviors of the Hedera Smart Contract Service token system contracts with those of EVM and typical token APIs such as ERC 20 and ERC 721.
* As a result, the following changes are made as of the mainnet 0.35.2 release on March 31st:
  * An EOA (externally owned account) will have to provide explicit approval/allowance to a contract if they want the contract to transfer value from their account balance.
  * The behavior of `transferFrom` system contract will be exactly the same as that of the ERC 20 and ERC 721 spec `transferFrom` function.
  * For HTS specific token functionality (e.g. Pause, Freeze, or Grant KYC), a contract will be authorized to perform the associated token management function only if the ContractId is listed as a key on the token (i.e. Pause Key, Freeze Key, KYC Key respectively).
  * The `transferToken` and `transferNFT` APIs will behave as `transfer` in ERC20/721 if the caller owns the value being transferred, otherwise it will rely on approve spender allowances from the token owner.
  * The above model will dictate entity (EOA and contracts) permissions during contract executions when modifying state. Contracts will no longer rely on Hedera transaction signature presence, but will instead be in accordance with EVM, ERC and ContractId key models noted.
* As part of this release, the network will include logic to grandfather in previous contracts.
  * Any contracts created from this release onwards will utilize the stricter security model and as such will not have considerations for top-level signatures on transactions to provide permissions.
  * Existing contracts deployed prior to this upgrade will be automatically grandfathered in and continue to use the old model that was in place prior to this release for a limited time to allow for DApp/UX modification to work with the new security model.
  * The grandfather logic will be maintained for an approximate period of 3 months from this release. In a future release in July 2023, the network will remove the grandfather logic, and all contracts will follow the new security model.
  * Developers are encouraged to test their DApps with new contracts and UX using the new security model to avoid unintended consequences. If any DApp developers fail to modify their applications or upgrade their contracts (as applicable) to adhere to the new security model, they may experience issues in their applications.

</details>
